## Память

Адресная шина 16 бит. Может задавать до 64 кБ памяти.

0000 0000 0000 0000 - 1111 1111 1111 1111
0 - 65 535
0 - FFFF

Первые 16 кБ памяти зарезервированы под системную область.

0000 0000 0000 0000 - 0011 1111 1111 1111
0 - 16 383
0 - 3FFF

Остальные 48 кБ отведены под общее назначение.

Системным флагом можно переназначать страницы этих 48 кБ памяти.

Остальные 48 кБ зарезервированы под видеопамять.

1100 0000 0000 0000 - 1111 1111 1111 1111
16 384 - 65 535
4000 - FFFF

Флагом можно Задавать страницу памяти

## Память

Память

Адресный диапазон | Назначение | Комментарий
00000h - 003FFh | Interrupt Vector Table | Таблица векторов прерываний. Номера векторов от 0 до FFhex (255dec)
00400h – 9FFFFh | Conventional Memory | Оперативная память для программ и данных
A0000h – BFFFFh | Video Memory | Графика (CGА/EGA/VGA), текстовый режим
C0000h – DFFFFh | Расширенная видеопамять | BIOS видеокарт, сетевых карт и т.п.
E0000h – FFFFFh | System / BIOS ROM | Постоянная память BIOS

### Память 128 кБ

#### 1

Кратко об устройстве памяти в SINCLAIR 128

128я память организована страничным образом.

Начиная с адреса #c000 (49152) длинною #4000 (16384) находится область, в которую можно включить другую страницу. Этим заведует порт #7ffd (32765), он стандартен для всех 128к машин.

#### 2

ZX Spectrum 128K не имеет отдельной 128-килобайтной памяти в привычном понимании. Вместо этого, он использует аппаратный переключатель страниц памяти, который позволяет динамически выделять дополнительную память для процессора и видеопамяти из общего пула в 128 КБ. Система использует 16 КБ для оперативной памяти, а остальные 112 КБ выделяются для программ и данных. 

Как это работает:

1. Память как единый пул:
Вся память в 128 КБ рассматривается как единый пул, из которого система выделяет нужные ресурсы.

2. Переключение страниц:
Процессор Zilog Z80, используемый в Spectrum, может переключать "страницы" памяти. Это позволяет ему видеть разные сегменты памяти как часть своего адресного пространства.

3. Выделение памяти:
16 КБ RAM: Эта область всегда доступна для работы программы.
112 КБ для данных и программ: Оставшаяся память может быть выделена для хранения больших программ, данных, а также видеопамяти (памяти для графики).

4. Аппаратное управление:
Переключение страниц осуществляется аппаратно, позволяя программе получить доступ к разным блокам памяти по мере необходимости.

5. Преимущества:
Благодаря такому механизму, ZX Spectrum 128K мог работать с более крупными программами и более сложными графическими режимами, чем 48-килобайтные модели.

#### 3

```
Компьютер SINCLAIR 128 имеет озу объемом 128 К, которое разделено на
8 банков памяти по 16 килобайт и которые условно нумеруются от 0 до 7.
В системе имеется регистр конфигурации, который доступен програмистоу
и имеет адрес 7FFDH. С помощью записи в этот регистр мы  можем менять
конфигурацию системы  т.е. переключать ПЗУ, банки ОЗУ и т.д.. Регистр
конфигурации имеет 6 разрядов. Первые три  ( с 0-го по 2-й )  разряда
определяют один из восьми банков банков, подлюченный в последний сек-
тор адресного пространства процессора.  3-й  определяет один  из  2-х
банков, который будет подлючен в первый сектор адресного пространства
и отображен на экран: 0 - подключен 5-й  банк, 1 - подключен 7-й банк.
4-й  разряд  определяет  ПЗУ:  0 - подключена прошивка BASIC 128, 1 -
BASIC 48. 5-й разряд заведует блокировкой записи в регистр конфигура-
ции:  0 - запись  разрешена,  1 - запись блокированна. Это необходимо
для работы в режиме SINCLAIR 48.

  АДРЕС Z-80         СЕКТОР                             ПЗУ 32К
                ---------------¬                    --------------¬
  0000-3FFF     ¦     16K      ¦ ___¦0 в разряде 4--+BASIC 128 16K¦
                ¦  0-й сектор  ¦    ¦1 в разряде 4--+BASIC 48  16K¦
                +--------------+                    L--------------
  4000-7FFF     ¦     16K      ¦ ___                    ОЗУ 128К
                ¦  1-й сектор  ¦    ¦1 в разряде 3--+7-й БАНК 16К ¦
                +--------------+    ¦               ¦6-й БАНК 16К ¦
  8000-BFFF     ¦     16К      ¦    ¦0 в разряде 3--+5-й БАНК 16К ¦
                ¦  2-й сектор  ¦                    ¦4-й БАНК 16К ¦
                +--------------+                    ¦3-й БАНК 16К ¦
  C000-FFFF     ¦     16К      ¦--------------------¦2-й БАНК 16К ¦
                ¦  3-й сектор  ¦     любой из       ¦1-й БАНК 16К ¦
                L---------------     8-ми           ¦0-й БАНК 16К ¦
                                     БАНКОВ ОЗУ     L--------------
                          000 в разрядах 2 - 0 - 0-й БАНК
                          001 ------------------ 1-й БАНК
                          ...............................
                          111 ------------------ 7-й БАНК
```

В первый сектор ничего не включается. он всегда на своем месте. и он равнозначен банку 5. т.е. если мы включем банк 5 и запишем в #c000 число, то реально оно будет доступно и по #4000. т.е. это одна и та же страница. но вот банк 7 со вторым экраном с областью #4000..#7fff никак не пересекаются.

Как (на примере) переключать страницы:

```
ld bc,#7ffd ; порт
ld a,1 ; 1й банк
or #10 ; пзу 48к
out (c),a ; переключить!
```

после этого в диапазоне #c000..#ffff будет выбранный банк.

если это юзать из бейсика, то надо зайти сначала в бейсик 128, выполнить там usr 0, сброситься в 48й бейсик, сделать clear XXX (где XXX<49152), и затем уже можно переключать страницы с помощью out 32765,Y+16 (где Y=номеру банка).

попробуйте сделать out 32765,5+16 и потом что-нить менять в адресах #c000..#daff.

или out 32765,7+16, потом загрузить картинку по адресу 49152, потом выполнить out 32765,7+16+8.

#### 4

Как следует из сказанного выше, общий объем памяти в 128 модели
достиг 160К, процессор же непосредственно может адресовать только 64К
из них. Выход из этого положения был найден сравнительно легко — через
механизм страничной адресации памяти. Адресное пространство процессора
было разделено на четыре равных раздела по 16К (иногда их называют
окнами), мы будем обозначать их CPU0...CPU3. Раздел CPU0 занимает адреса
0...#3FFF, CPU1 — #4000...#7FFF, CPU2 — #8000...#BFFF и CPU3 — #C000...#FFFF.
Вся память также была разделена на сегменты по 16К,
называемые еще банками памяти, или страницами памяти. Мы будем обоз-
начать банки ПЗУ через ROMO и ROM1, а банки ОЗУ от RAM0 до RAM7.
Через специальный механизм (который мы рассмотрим ниже) программист
может по своему усмотрению устанавливать в адресные разделы микропро-
цессора те или иные банки памяти. На рис. 15 показано, какая память где
может находиться.

Банк ROMO содержит расширение интерпретатора языка Бейсик,
встроенного в компьютер, написанное специально для 128 модели, а содер-
жимое ROM1 практически полностью совпадает с ПЗУ из стандартного ZX
Spectrum. Находиться эти банки могут только в адресном разделе микропро-
цессора CPU0. Разделам CPU1 и CPU2 соответствуют фиксированные банки
ОЗУ, RAM2 и RAM5 соответственно. В разделе CPU3 можно установить
любой из банков ОЗУ.

Механизм страничной адресации памяти, а также музыкальный про-
цессор и иная организация принтера потребовал расширения стандартных
внешних устройств, обрабатываемых «внутри» компьютера. Выше писалось,
что выбор устройств в ZX Spectrum осуществляется сбросом в ноль какого-
либо разряда шины адреса. Для ZX Spectrum 128 это верно только наполо-
вину. Действительно, для обращения к дополнительным портам в младших
восьми разрядах устанавливается в ноль адрес А1. Таким образом, общий
адрес внешних устройств должен быть #FD. Выбор же конкретного устрой-
ства определяют адреса А14 и А15.

Порт 32765 l#7FFD, %1111111111111101)

Отдельными битами этого порта осуществляется управление конфи-
гурацией компьютера. Отметим, что этот порт доступен только для записи,
поэтому интерпретатор Бейсика в системных переменных по адресу 23388
(#5В5С) хранит копию этого регистра:

биты 0...2 определеяют номер страницы ОЗУ, установленной в адресном
разделе CPU3 микропроцессора:

000 (0) - RAM0

001 (1) - RAMI

010 (2) - RAM2

011 (3) - RAM3

100 (4) - RAM4

101 (5) - RAM5

110 (6) - RAM6

111 (7) - RAM7

бит 3 управляет режимом отображения информации, точнее, номером
видеостраницы, содержимое которой выводигся на монитор. Если бит
сброшен, то на дисплей выводятся значения из стандартной экранной
области памяти, расположенной в адресах #4000...#5AFF (банк
RAM5). Если же бит установлен, то отображаются данные из второй
видеостраницы, находящейся в банке RAM7. Обратите внимание, что
такое решение позволяет полностью исключить «видеопамять» из
адресного пространства микропроцессора и подключать ее по мере
необходимости, тогда как изображение на экране будет выводиться
постоянно;

бит 4 определяет содержимое адресного раздела микропроцессора CPU0.
Если бит сброшен, то адресуется банк ROMO, содержащий коды
расширения интерпретатора Бейсика; если бит установлен, в адресах
0...#3FFF будет находиться банк ROM1, где хранится практически не
измененная копия обычного ПЗУ Speccy.

бит 5 управляет режимом совместимости с обычным ZX Spectrum, уста-
новка этого бита приведет к отключению дополнительной памяти,
таким образом, компьютер практически полностью превратится в
старый добрый Speccy. Отметим, что сбросить значение этого бита
программным путем невозможно, необходим аппаратный «сброс»
всего компьютера.

Остальные биты из этого порта не используются.

Порт 49149 (#BFFD, %1011111111111101)
Порт 65533 (#FFFD, %1111111111111101)

Через эти порты осуществляется адресация восьмиразрядных регист-
ров музыкального процессора. Всего таких регистров шестнадцать, мы будем
обозначать их R0...R15. Регистры двунаправленные, то есть информацию в
них можно записывать и считывать. Для доступа к какому-либо регистру его
номер (число в диапазоне от 0 до 15) необходимо записать по адресу 65533.
После этого становится возможна передача данных между этим «установлен-
ным» или текущим регистром и микропроцессором. Для смены текущего
регистра соответствующий номер нужно записать в порт 65533, и так далее.

Обратите внимание, что адреса для чтения и записи информации в
текущий регистр музыкального процессора различны. Для записи байта
нужно выполнить команду вывода в порт с адресом 49149, а для чтения —
команду ввода из порта с адресом 65533.

Прежде чем разобрать функции отдельных регистров музыкального
процессора, остановимся на его особенностях. Микросхема музыкального
процессора имеет три независимых канала для формирования звука (обоз-
начаются А, В и С) и два двунапрвленных восьмиразрядных канала вво-
да/вывода — IRA и IRB, соответственно. Через канал IRA осуществляется
связь с принтером, вывод сигналов для специального музыкального интер-
фейса MIDI и, кроме этого, связь со специальной выносной клавиатурой
функциональных клавиш, используемых в расширенном интерпретаторе
Бейсика.

__Регистры RO/RI, R2/R3, R4/R5

Три спаренных регистра R0/R1, R2/R3, R4/R5 используются для вы-
работки частоты тона соответственно каналов А, В и С. Необходимые двенад-
цатиразрядные значения образуются из восьми бит младшего по номеру
регистра и четырех младших бит старшего по номеру регистра.

Регистр R6

Младшие пять разрядов этого регистра задают частоту шума.

Регистр R7

Через этот регистр осуществляется управление звуковыми каналами
и регистрами ввода/вывода:

биты 0...2 используются для управления выводом частоты тона. Установка
битов 0, 1 или 2 приведет к запрещению вывода частоты тона в
каналы А, В и С соответственно;
биты 3...5 используются для управления выводом частоты шума. Установ-
ка битов 3, 4 или 5 приведет к запрещению вывода частоты шума в
каналы А, В и С соответственно;
биты в и 7 устанавливают режим работы каналов IRB и IRA соответст-
венно. При сброшенном бите канал работает на ввод, а при установ-
ленном — на вывод информации.

Регистры R8, R9 и RfQ

Младшие пять разрядов регистров R8, R9 и R10 управляют соответст-
венно амплитудой каналов А, В и С.

Регистры R11/R12

Спаренные регистры RH/R12 образуют шестнадцатиразрядное зна-
чение огибающей выходного сигнала, регистр R11 несет младший байт, а

R12 — старший.

Регистр R13

Младшие четыре разряда этого регистра управляют формой и режи-
мом огибающей выходного сигнала:

бит 0 — затухание;
бит 1 — чередование;
бит 2 — нарастание;
бит 3 — продолжение.

Регистры R14 и R15

Регистры R14 и R15 используются соответственно для связи с канала-
ми ввода/вывода IRA и IRB. Содержимое этих регистров можно в любой
момент считывать и записывать, на формировании звука это никак не

отражается.
