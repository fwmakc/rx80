# Видео

## Цветовая палитра

Цветовая палитра кодируется 4 битами. Три младших бита задают цвет. Старший бит задает яркость.

Вот примерная цветовая раскладка по битам.

биты | R, G, B       | название
-----------------------------
0000 |   0,   0,   0 | черный
0001 |   0,   0, 255 | синий
0010 |   0, 255,   0 | зеленый
0011 |   0, 255, 255 | голубой
0100 | 255,   0,   0 | красный
0101 | 255,   0, 255 | фиолетовый
0110 | 255, 255,   0 | желтый
0111 | 255, 255, 255 | белый
1000 |  64,  64,  64 | темно-серый
1001 |   0,   0, 191 | темно-синий
1010 |   0, 191,   0 | темно-зеленый
1011 |   0, 191, 191 | темно-голубой
1100 | 191,   0,   0 | темно-красный
1101 | 191,   0, 191 | темно-фиолетовый
1110 | 191, 191,   0 | темно-желтый
1111 | 191, 191, 191 | серый

Если вы посмотрите внимательно, то заметите, что значение 0 выключает яркость, а значение включает ее на максимальное значение. Старший бит гасит яркость в 3/4 от максимального значения.

Отдельно можно посмотреть на цвет с кодом 1000. Здесь старший бит, наоборот, поднимает минимальное значение на 1/4.

Цветовой сигнал в стандарте PAL и NTSC является сжатым по цветовым характеристикам, поэтому он не даст ни полностью белый, ни полностью черный цвета. Если оцифровать яркостную составляющую в 256 значений (дискретность 8 бит), то отображаемый диапазон будет лежать между значениями 16 и 235.

За вывод цвета отвечает графический адаптер. Он преобразовывает код цветовой палитры в сигнал для каждого из каналов: R (красный), G (зеленый) и (B) синий.

На самом деле, выходной сигнал может быть гораздо сложнее. Например, он может передавать не цветовые компоненты, а смещение в пространстве YCbCr. Но это ответственность графического адаптера. Нас же интересует только то, в каком цифровом виде адаптер получает данные о цвете.

Для каждого канала и для каждого кода палитры можно задать смещение яркости. Таким образом, фактически, можно изменить палитру.

По-умолчанию, смещение преобразует палитру в следующие цвета:

биты | R, G, B       | hex       | название
-------------------------------------------
0000 |  15,  15,  15 | #0F0F0F | черный
0001 |  15,  15, 239 | #0F0FEF | синий
0010 |  15, 239,  15 | #0FEF0F | зеленый
0011 |  15, 239, 239 | #0FEFEF | голубой
0100 | 239,  15,  15 | #EF0F0F | красный
0101 | 239,  15, 239 | #EF0FEF | фиолетовый
0110 | 239, 239,  15 | #EFEF0F | желтый
0111 | 239, 239, 239 | #EFEFEF | белый
1000 |  95,  95,  95 | #5F5F5F | темно-серый
1001 |  15,  15, 175 | #0F0FAF | темно-синий
1010 |  15, 175,  15 | #0FAF0F | темно-зеленый
1011 |  15, 175, 175 | #0FAFAF | темно-голубой
1100 | 175,  15,  15 | #AF0F0F | темно-красный
1101 | 175,  15, 175 | #AF0FAF | темно-фиолетовый
1110 | 175, 175,  15 | #AFAF0F | темно-желтый
1111 | 175, 175, 175 | #AFAFAF | серый

В памяти под смещение зарезервировано 4 бита. Старший бит задает знак, а три младших - степень смещения.

Каждый бит смещает значение на 16 единиц.

```
0000 - без смещения, 0 в положительную сторону
0001 - +15
0010 - +31
0011 - +47
0100 - +63
0101 - +79
0110 - +95
0111 - +111
```

И в обратную сторону:

```
1000 - -112
1001 - -96
1010 - -80
1011 - -64
1100 - -48
1101 - -32
1110 - -16
1111 - без смещения, 0 в отрицательную сторону
```

Попробуем задать смещение, чтобы получить цвета более пастельных оттенков.

Со смещением по-умолчанию:

биты | исходные      | смещение      | R, G, B       | hex       | название
---------------------------------------------------------------------------
0000 |   0,   0,   0 |  15,  15,  15 |  15,  15,  15 | #0F0F0F | черный
0111 | 255, 255, 255 | -16, -16, -16 | 239, 239, 239 | #EFEFEF | белый
1000 |  64,  64,  64 |  31,  31,  31 |  95,  95,  95 | #5F5F5F | темно-серый
1111 | 191, 191, 191 | -16, -16, -16 | 175, 175, 175 | #AFAFAF | серый

Смещения с верхним битовым флагом 0:

биты | исходные      | смещение      | R, G, B       | hex       | название
---------------------------------------------------------------------------
0001 |   0,   0, 255 |  15,  79, -32 |  15, 111, 223 | #0F6FDF | синий
0010 |   0, 255,   0 |  15, -48,  79 |  15, 207, 111 | #0FCF6F | зеленый
0011 |   0, 255, 255 |  15, -48, -32 |  15, 207, 223 | #0FCFDF | голубой
0100 | 255,   0,   0 | -16,  79,  79 | 239, 111, 111 | #EF6F6F | красный
0101 | 255,   0, 255 | -16,  79, -32 | 239, 111, 223 | #EF6FDF | фиолетовый
0110 | 255, 255,   0 | -16, -48,  79 | 239, 207, 111 | #EFCF6F | желтый

Смещения с верхним битовым флагом 1:

биты | исходные      | смещение      | R, G, B       | hex       | название
---------------------------------------------------------------------------
1001 |   0,   0, 191 |  15,  79, -32 |  15,  79, 111 | #0F4F6F | темно-синий
1010 |   0, 191,   0 |  15, -80,  79 |  15, 111,  15 | #0F6F0F | темно-зеленый
1011 |   0, 191, 191 |  15, -80, -32 |  15, 111, 111 | #0F6F6F | темно-голубой
1100 | 191,   0,   0 | -16,  79,  79 | 175,  79,  15 | #AF4F0F | темно-красный
1101 | 191,   0, 191 | -16,  79, -32 | 175,  79, 111 | #AF4F6F | темно-фиолетовый
1110 | 191, 191,   0 | -16, -80,  79 | 175, 111,  15 | #AF6F0F | темно-желтый

## Видеопамять

Видеопамять представляет собой отдельную память, расположенную на материнской плате компьютера. Доступ к ней может осуществлять как ЦП, так и графический адаптер.

По 16 битной адресной шине мы можем адресовать до 64 кБ памяти:

```
2 ^ 16 + 1 = 65 536 байт
```

Или:

```
0 ... 65 535 - в 10й системе
0000 ... FFFF - в 16й системе
```

Вот как она распределена:

название     | размер  | адреса в 10й системе | адреса в 16й системе
--------------------------------------------------------------------
системная    |  1 кБ   |      0 -  1 023      | 0000 - 03FF
общая        | 16 кБ   |  1 024 - 17 407      | 3400 - 43FF
текстовая    |  1 кБ   | 17 408 - 18 431      | 4400 - 47FF
спрайтовая   |  8 кБ   | 18 432 - 26 623      | 4800 - 67FF
экранная     | 37.5 кБ | 26 624 - 65 023      | 6800 - FDFF
служебная    |  0.5 кБ | 65 024 - 65 535      | FE00 - FFFF
палитра      | 24 Б    | 65 512 - 65 535      | FFE8 - FFFF

### Системная область видеопамяти

Область видеопамяти размером в 1 кБ с начала адресного пространства зарезервирована под системные нужды графического адаптера.

### Общая область видеопамяти

Под свободную область видеопамяти выделено 12 кБ адресного пространства.

В эту область помещаются временные данные, с которыми может работать как ЦП, так и графический адаптер.

Например, существуют графические адаптеры, у которых есть свой процессор, который может растеризовать графику, делать вычисления самостоятельно, разгружая таким образом ЦП системы.

В эту область памяти можно поместить сырые данные, которые затем будут обработаны графическим процессором.

### Текстовая область

Для упрощенного текстового видеорежима есть своя область памяти, где хранятся символы ASCII.

Здесь каждый символ имеет размер 4 x 8 пикселей, кодируется одним битом и занимает 4 байта:

```
4 (ширина знакоместа) * 8 (высота знакоместа) * 1 (бит на пиксель) / 8 (бит в 1 байте) = 4 байта
```

Все вместе они занимают всего 1 кБ:

```
4 (байта размер символа) * 256 (число символов) = 1 024 байт
```

### Спрайтовая область

В видеопамяти есть отдельная область, которая отводится под хранение спрайтов.

Размер каждого спрайта 8 x 8 пикселей.

Каждый пиксель спрайта кодируется маской из 2 бит:

```
00 - ключ, обычно цвет фона
01 - главный цвет
10 - второй цвет
11 - прозрачный пиксель
```

В результате, каждый символ занимает 16 байт:

```
8 (ширина спрайта) * 8 (высота спрайта) * 2 (бита на пиксель) / 8 (бит в 1 байте) = 16 байт
```

Для хранения спрайтов есть две страницы:

- первая, 256 символов, 0-255 - это символы ASCII,
- вторая, 256 символов, 256-511 - это свободная область для хранения спрайтов.

Все вместе они занимают 8 кБ.

На самом деле, вы можете располагать спрайты так, как вам удобно, в том числе вместо символов ASCII.

Каждый символ имеет свой номер, согласно таблице ASCII.

Например, символ цифры **0** имеет следующий номер:

```
48 - в 10й системе
0030 - в 16й системе
```

Соответственно, он будет располагаться в области памяти со смещением:

```
18 432 (начало спрайтовой области) + ( 16 (байт) * 48 (номер символа) )
```

### Экранная область

В графическом режиме каждый пиксель кодируется четырьмя битами, согласно цветовой палитре.

Таким образом, весь экран в видеопамяти занимает объем 37.5 кБ:

```
320 (ширина экрана) * 240 (высота экрана) * 4 (бита на пиксель) / 8 (бит в 1 байте) = 38 400 байт
```

Это адреса:

```
26 624 ... 65 023 - в 10й системе
6800 ... FDFF - в 16й системе
```

Мы можем обращаться к видеопамяти напрямую, помещая в определенные ячейки определенные значения. И таким образом, мы будем рисовать на экране.

Видеоподсистема считывает данные из видеопамяти и отправляет их в блок декодера по внутренней шине, откуда они уже выводятся на экран.

### Служебная область

Это оставшаяся область памяти. В данном случае, последние 512 байт.

В служебной области задаются режимы и палитра.

Режим экрана задается двумя младшими битами по адресу:

```
65 024 - в 10й системе
FE00 - в 16й системе
```

По-умолчанию это текстовый режим:

```
00000000
```

Фон экрана и цвет вывода задаются по 4 бита по адресу:

```
65 025 - в 10й системе
FE01 - в 16й системе
```

По-умолчанию это белый текст на черном фоне:

```
00000111
```

Палитра занимает последние 24 байта:

```
65 512 ... 65 535 - в 10й системе
FFE8 ... FFFF - в 16й системе
```

Мы уже говорили о дискретизации палитры. Смещение палитры также имеет область в памяти.

Напомним. У нас есть палитра в четыре бита. Каждый бит кодирует цветовой канал: R (красный), G (зеленый) и (B) синий.

В этой области памяти мы можем задавать смещение для каждого из каналов палитры. Под смещение также зарезервировано 4 бита.

Итого, палитра и смещение занимают в памяти 24 байта:

```
4 (бита на канал) * 3 (число каналов) * 16 (кодов палитры) / 8 (бит в 1 байте) = 24 байта
```

По-умолчанию здесь записано:

```
11 11 1E 1E 11 EE E1 1E 1E EE 1E EE 22 21 1E 1E 11 EE E1 1E 1E EE 1E EE
```

Если вы хотите сделать пастельную палитру, сюда нужно записать:

```
11 11 5D 1C 51 CD E5 5E 5D EC 5E EE 22 21 5D 1A 51 AD E5 5E 5D EA 5E EE
```

## Формирование изображения

Для дальнейшего описания нужно понимать, как графический адаптер формирует вывод на экран.

Нам не важно во всех деталях представлять техническое устройство графического адаптера и его работу. Тем не менее, нужно отметить следующие моменты.

Графический адаптер имеет доступ к видеопамяти, как и ЦП.

Через данные, размещенные в видеопамяти, мы можем управлять выводом изображения.

Графический адаптер считывает данные из видеопамяти, производит определенные действия по суммированию битов из разных областей и затем выводит изображение на экран.

Представим этот процесс поэтапно. Хотя на самом деле, вся последовательность действий может происходить одновременно.

1. Графический адаптер читает экранную область памяти и формирует начальный слой. Фон экрана он берет из служебной памяти.

2. Графический адаптер переходит в один из трех режимов работы.

3. Для графического режима, он читает содержимое экранной области как есть. Так формируется изображение поверх фона.

4. Для текстового режима, он читает коды символов из экранной области, затем выбирает символы из текстовой области памяти и выводит их поверх изображения с заданным цветом.

5. Для спрайтового режима, он читает из экранной области коды спрайтов и размещает их поверх изображения.

Мы можем представить каждый этап формирования изображения как слой поверх предыдущего. Такой вывод называется overlay.

В порядке очереди всегда выводится сначала графическая область, затем спрайты, затем текст. Иначе говоря, текст будет выведен поверх спрайтов и графики.

Также важно понимать, что графический адаптер только считывает, но ничего не записывает в экранную область памяти. Все операции он производит на своей стороне.

Графический адаптер формирует картинку с частотой примерно 50-60 раз в секунду.

## Видеорежимы

Архитектурно поддерживаются три видеорежима:

- текстовый, 80 х 30 символов по 4 х 8 пикселей,
- спрайтовый, 40 х 30 символов по 8 x 8 пикселей,
- графический, 320 x 240 пикселей.

### Текстовый режим

В текстовом режиме на экран выводятся символы, помещенные в экранную область памяти. Вывод идет последовательно, без указания координат.

В этом режиме происходит вызов подпрограммы, которая автоматически читает коды символов, загружает их из текстовой области памяти, считает включенные биты и кладет их на экранную область в режиме overlay.

Символы берутся из текстовой области памяти. Там они занимают знакоместо размером 4 пикселя по ширине и 8 пикселей по высоте.

Помимо печатаемых символов, есть непечатаемые символы, вроде табуляции и переноса строки. Такие символы не выводятся на экран, но позволяют управлять выводом. Они также называются управляющими кодами.

За счет управляющих кодов можно также передвинуть позицию курсора, поменять цвет фона и цвет пикселей.

Можно подсчитать, что вывод максимального числа символов на экране займер всего 2 400 байт.

### Спрайтовый режим

В спрайтовом режиме также задействуется экранная область памяти. Но теперь она обрабатывается другим образом.

Каждый спрайт, помимо кода, имеет параметры вывода:

- 16 бит (9 значимых) задают номер спрайта, от 0 до 512
- 16 бит (11 значимых) задают номер знакоместа, от 0 до 1199
- 8 бит (7 значимых) задают смещение в знакоместе (со знаком), от -64 до 64
- 8 бит (4 значимых) задают код из палитры для ключа (фона)
- 8 бит (4 значимых) задают код из палитры для первого цвета
- 8 бит (4 значимых) задают код из палитры для второго цвета

Всего размещение 1 спрайта на экране занимает 8 байт.

Легко подсчитать, что если занять всю экранную область памяти, то получится вывести 4 800 спрайтов.

Спрайты могут перекрывать друг друга. В таком случае приоритет имеет последний вызванный спрайт.

### Графический режим

Здесь все просто.

В графическом режиме экранная область памяти устанавливает пиксели, как описано выше.

### Мультирежим

Самая интересная возможность видеоподсистемы - это сочетание режимов на одном экране.

В служебной области памяти, начиная с самого первого адреса 65 024, мы можем задать режимы экрана.

Первый байт отводится на кодирование фона и цвета по-умолчанию:

- 4 бита задают фон
- 4 бита задают цвет

Второй байт устанавливает режим в виде флагов. Всего 4 бита, от младшего к старшему:

- текстовый режим
- спрайтовый режим
- графическый режим

Далее каждые 2 байта (16 бит) задают смещение ячейки памяти для каждого из четырех режимов.

По-умолчанию установлено значение (в 16й системе):

```
07 01 68 00 78 00 68 00
```

Давайте разберем эти значения

hex   | bit / число | описание
------------------------------
07    |   0000 0111 | черный цвет фона, белый цвет пикселей
01    |           1 | включен текстовый режим
68 00 |      26 624 | текстовый режим, область памяти с адреса 26 624
78 00 |      30 720 | спрайтовый режим, область памяти с адреса 30 720
68 00 |      26 624 | графический режим, область памяти с адреса 26 624

Но мы можем записать другие значения с другими смещениями.

Например, мы хотим задать все три области памяти одновременно:

- графический режим,
- спрайтовый режим,
- текстовый режим.

Закодируем текстовый режим. Для него нам достаточно 3 кБ экранной памяти:

```
80 (символов в ширину) * 30 (символов в высоту) * 8 (бит на символ) / 8 (бит в 1 байте) = 2400 байт
+ запас на управляющие коды
```

Поместим его в общую область видеопамяти, начиная с адреса 1 024 (04 00 в 16й системе).

Закодируем спрайтовый режим. Для него выделим место сразу после текстовой области:

```
1 024 + 3 072 = 4 096 (10 00 в 16й системе)
```

Графический режим мы оставим в экранной области и не будем переназначать.

Все, что нам осталось - это включить все три бита режимов:

```
0111 - в 2й системе
07 - в 16й системе
```

Итоговый код:

```
07 07 04 00 10 00 68 00
```

Давайте еще раз подробно разберем эти значения

hex   | bit / число | описание
------------------------------
07    |   0000 0111 | черный цвет фона, белый цвет пикселей
07    |        0111 | включены все три режима
04 00 |       1 024 | область памяти текстового режима
10 00 |       4 096 | область памяти спрайтового режима
68 00 |      26 624 | область памяти графического режима

Теперь, если мы хотим вывести что-то, например, в текстовом режиме, нам нужно поместить данные в область, начиная с адреса 1 024 (04 00 в 16й системе). Графический режим мы можем использовать как обычно.
