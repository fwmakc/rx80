# Прерывания

## Аппаратные прерывания

Аппаратные прерывания — это сигналы от внешних или внутренних устройств процессору, которые требуют немедленного внимания.

Когда аппаратное устройство (например, таймер или клавиатура) хочет что-то сообщить процессору:

- Оно отправляет аппаратный сигнал прерывания
- Процессор временно приостанавливает выполнение текущей программы
- Переходит к обработчику прерывания (специальной программе)

Как это работает внутри

На системной плате с CPU есть контроллер прерываний, который определяет, какое именно устройство вызвало прерывание.

Каждый тип прерывания связан с уникальным номером (вектором), формируемым контроллером прерываний, и обработчиком в памяти.

Адрес обработчика прерывания вычисляется так:

Смещение обработчика = WORD PTR [Вектор × 4]

Квадратные скобки сообщают нам, что из ячейки памяти размером 1 слово (2 байта или 16 бит) с адресом Вектор × 4 нужно извлечь содержимое, тоже размером 1 слово, и уже его использовать как целевое смещение нужного нам объекта в памяти. В данном случае это будет смещение обработчика прерывания.

Сегмент обработчика = WORD PTR [(Вектор × 4) + 2]

Тот же самый смысл имеют квадратные скобки в случае сегмента: из ячейки памяти размером 1 слово с адресом (Вектор × 4) + 2 извлекаем содержимое и используем его как сегментный адрес обработчика прерывания.

Процедура извлечения из памяти адреса другого участка памяти называется "косвенная адресация". Если вы знакомы с программированием на C, то, возможно, сталкивались с разыменованием указателя. Вот это оно и есть.

При аппаратном прерывании процессор:

- Ждёт завершения текущей исполняемой инструкции
- Сохраняет в стек регистры FLAGS, CS, IP.
- Загружает адрес обработчика из таблицы векторов прерываний в CS:IP.
- Выполняет код обработчика.

После выполнения обработчика команда IRET (interrupt return) возвращает процессор к прерванной задаче, извлекая из стека регистры IP, CS, FLAGS.

Примеры аппаратных прерываний

Номер | Описание
INT 08h | Таймер. По-умолчанию обработчик вызывается каждые ~55 мс
INT 09h | Клавиатура
INT 0Ah-INT 0Fh | Прерывания других периферийных устройств (настраиваются через контроллер PIC)

## Программные прерывания

Программные прерывания — это прерывания, которые инициируются самим кодом программы с помощью специальной инструкции INT.

То есть, мы можем принудительно "прервать" выполнение программы и вызвать системную функцию или собственный обработчик.

Как вызвать программное прерывание?

Очень просто:

```
INT вектор
```

Примеры программных прерываний

Инструкция | Назначение
INT 10h | Работа с видео (BIOS-функции для вывода текста и графики)
INT 13h | Доступ к дисковым устройствам (чтение/запись секторов)
INT 16h | Чтение клавиатуры
INT 21h | DOS-функции: ввод/вывод, работа с файлами

Что происходит при программном прерывании?

Когда процессор выполняет INT xx:

- Он делает примерно то же самое, что при аппаратном прерывании:
- Сохраняет FLAGS, CS, IP в стек.
- Загружает новый CS:IP из таблицы векторов прерываний по номеру прерывания.
- Выполняет код обработчика.

После выполнения обработчика команда IRET (interrupt return) возвращает процессор к прерванной задаче, извлекая из стека регистры IP, CS, FLAGS.

То есть, механизм тот же - отличается только источник сигнала.
